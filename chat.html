<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rivo - Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  
  <!-- Header -->
  <header class="bg-violet-600 text-white p-4 text-lg font-semibold text-center shadow">
    Rivo Chat
  </header>

  <!-- Chat Container -->
  <main class="flex-1 max-w-3xl mx-auto w-full p-4 flex flex-col">
    <!-- Messages -->
    <div id="messagesArea" class="flex-1 overflow-y-auto bg-white p-4 rounded shadow">
      <!-- Messages will be injected here -->
    </div>

    <!-- Input Box -->
    <div class="mt-4 flex items-center gap-2">
      <input id="messageInput" type="text" placeholder="Type a message..." 
        class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-violet-300"/>
      <button id="sendBtn" class="bg-violet-600 text-white px-4 py-2 rounded">Send</button>
    </div>
  </main>

  <!-- Auth Buttons -->
  <div class="p-4 text-center">
    <button id="signInBtn" class="bg-violet-600 text-white px-3 py-1 rounded">Sign in</button>
    <button id="signOutBtn" class="hidden px-3 py-1 bg-gray-300 rounded">Sign out</button>
  </div>

<script type="module">
  import '/assets/js/realtime-app.js';

  import { getDatabase, ref, push, onChildAdded, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const auth = getAuth();
  const db = getDatabase();
  const messagesArea = document.getElementById('messagesArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  // Load messages in real-time
  const chatRef = ref(db, 'chat/general');
  onChildAdded(chatRef, (snapshot) => {
    const msg = snapshot.val();
    const div = document.createElement('div');
    div.className = "mb-2";
    div.innerHTML = `<strong>${msg.senderName || 'Anonymous'}:</strong> ${msg.text}`;
    messagesArea.appendChild(div);
    messagesArea.scrollTop = messagesArea.scrollHeight;
  });

  // Send message
  sendBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) {
      alert('Sign in to send messages');
      return;
    }
    const text = messageInput.value.trim();
    if (!text) return;
    await push(chatRef, {
      senderId: user.uid,
      senderName: user.displayName || user.email || 'User',
      text,
      timestamp: serverTimestamp()
    });
    messageInput.value = '';
  });

  // Show/hide sign out
  window.addEventListener('rivo:authChange', (e) => {
    const u = e.detail;
    document.getElementById('signOutBtn').classList.toggle('hidden', !u);
  });

</script>
</body>
</html>