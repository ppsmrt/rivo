<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rivo - Notifications</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { background: #f8fafc; font-family: Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial; }
    .notif-card { transition: transform .12s ease, box-shadow .12s ease; }
    .notif-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(15,23,42,.08); }
  </style>
</head>
<body class="min-h-screen">

  <!-- Header (shared look) -->
  <header class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold text-violet-600">Rivo</h1>
      <nav class="flex items-center gap-4 text-sm text-gray-600">
        <a href="index.html" class="hover:text-violet-600">Home</a>
        <a href="explore.html" class="hover:text-violet-600">Explore</a>
        <a href="profile.html" class="hover:text-violet-600">Profile</a>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-4">
    <section class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Notifications</h2>
        <div id="notif-count" class="text-sm text-gray-500">0</div>
      </div>

      <div id="notificationsList" class="space-y-3">
        <div id="placeholder" class="text-gray-500 text-center py-8">Loading notificationsâ€¦</div>
      </div>
    </section>
  </main>

  <footer class="max-w-3xl mx-auto p-4 text-center text-xs text-gray-400">
    &copy; 2025 Rivo
  </footer>

  <!-- Centralized Firebase + logic -->
  <script type="module">
    // Uses the centralized firebase-init.js for app/auth/db exports
    import '/assets/js/firebase-init.js'; // ensures firebase app is initialized
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const auth = getAuth();
    const db = getDatabase();

    const listEl = document.getElementById('notificationsList');
    const countEl = document.getElementById('notif-count');
    const placeholder = document.getElementById('placeholder');

    // helper: time ago
    function timeAgo(ts) {
      if (!ts) return '';
      const seconds = Math.floor((Date.now() - ts) / 1000);
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h`;
      const days = Math.floor(hours / 24);
      return `${days}d`;
    }

    // render a single notification card
    function renderNotifCard(id, n, uid) {
      const readBg = n.read ? 'bg-white' : 'bg-violet-50';
      const title = n.title || (n.type ? (n.type.charAt(0).toUpperCase() + n.type.slice(1)) : 'Notification');
      const message = n.message || n.text || '';
      const created = n.createdAt || n.createdAtMillis || 0;

      return `
        <div data-id="${id}" class="notif-card p-4 rounded border ${readBg}">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                <i class="fa-regular fa-bell"></i>
              </div>
            </div>

            <div class="flex-1">
              <div class="flex items-start gap-2">
                <div class="font-medium">${escapeHtml(title)}</div>
                <div class="text-xs text-gray-400 ml-auto">${timeAgo(created)}</div>
              </div>
              <div class="text-sm text-gray-700 mt-1">${escapeHtml(message)}</div>

              <div class="mt-3 flex gap-2 items-center">
                ${!n.read ? `<button class="markRead text-xs px-2 py-1 rounded bg-green-600 text-white" data-id="${id}">Mark read</button>` : ''}
                <button class="deleteNotif text-xs px-2 py-1 rounded bg-red-600 text-white" data-id="${id}">Delete</button>
                ${n.link ? `<a href="${escapeHtml(n.link)}" class="text-xs ml-auto text-violet-600 hover:underline">Open</a>` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]);
    }

    // ensure user is signed in, then listen to notifications/{uid}
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        listEl.innerHTML = `<div class="text-center text-gray-500 py-8">Sign in to see notifications.</div>`;
        countEl.textContent = '0';
        return;
      }

      const notifRef = ref(db, `notifications/${user.uid}`);

      // realtime listener
      onValue(notifRef, (snap) => {
        if (!snap.exists()) {
          listEl.innerHTML = `<div class="text-gray-500 text-center py-8">No notifications yet.</div>`;
          countEl.textContent = '0';
          return;
        }

        // convert to array and sort by createdAt descending (newest first)
        const items = [];
        snap.forEach(child => {
          const id = child.key;
          const val = child.val();
          // prefer createdAt numeric, but support other keys
          const createdAt = (val.createdAt || val.createdAtMillis || val.ts || val.timestamp || 0);
          items.push({ id, val, createdAt });
        });

        items.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

        // render
        countEl.textContent = String(items.length);
        listEl.innerHTML = items.map(it => renderNotifCard(it.id, it.val, user.uid)).join('');

        // attach handlers for newly rendered buttons
        listEl.querySelectorAll('.markRead').forEach(btn => {
          btn.removeEventListener('click', markReadHandler);
          btn.addEventListener('click', markReadHandler);
        });
        listEl.querySelectorAll('.deleteNotif').forEach(btn => {
          btn.removeEventListener('click', deleteHandler);
          btn.addEventListener('click', deleteHandler);
        });
      }, (err) => {
        console.error('notifications onValue error', err);
        listEl.innerHTML = `<div class="text-red-500 text-center py-8">Failed to load notifications.</div>`;
      });
    });

    // handler functions
    function markReadHandler(e) {
      const id = e.currentTarget.dataset.id;
      if (!id) return;
      const user = auth.currentUser;
      if (!user) { alert('Sign in to manage notifications'); return; }
      const p = ref(db, `notifications/${user.uid}/${id}`);
      update(p, { read: true }).catch(err => {
        console.error('markRead failed', err);
        alert('Could not mark read');
      });
    }

    function deleteHandler(e) {
      const id = e.currentTarget.dataset.id;
      if (!id) return;
      if (!confirm('Delete this notification?')) return;
      const user = auth.currentUser;
      if (!user) { alert('Sign in to manage notifications'); return; }
      const p = ref(db, `notifications/${user.uid}/${id}`);
      remove(p).catch(err => {
        console.error('delete notification failed', err);
        alert('Could not delete notification');
      });
    }
  </script>
</body>
</html>