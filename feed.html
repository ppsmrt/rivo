<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rivo — Feed</title>

  <!-- Tailwind + Font Awesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{--violet:#7c3aed}
    body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:#f8fafc}
    .post-card{border-radius:12px;overflow:hidden;background:#fff;box-shadow:0 6px 18px rgba(17,24,39,.04)}
    .post-media img,.post-media video{width:100%;height:auto;display:block;object-fit:cover}
    .like-btn.liked{color:#ef476f;transform:scale(1.04)}
    .heart-anim{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;font-size:5rem;color:rgba(255,80,120,.95);opacity:0;transition:opacity .35s ease,transform .35s ease;transform:scale(.95)}
    .heart-anim.show{opacity:1;transform:scale(1)}
    .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,.6);z-index:70;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-inner{width:95%;max-width:980px;background:#fff;border-radius:12px;overflow:hidden;display:flex}
    @media(max-width:768px){ .modal-inner{flex-direction:column} .modal-media{width:100%} .modal-info{width:100%} }
    .scrollbar-thin::-webkit-scrollbar{height:6px;width:6px}
    .small-muted{color:#6b7280}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-3xl mx-auto flex items-center justify-between px-4 py-3">
      <div class="flex items-center gap-3">
        <h1 class="text-xl font-bold text-violet-600">Rivo</h1>
      </div>

      <div id="authControls" class="flex items-center gap-3">
        <button id="signInBtn" class="px-3 py-1 rounded-lg bg-violet-600 text-white flex items-center gap-2">
          <i class="fa-brands fa-google"></i> Sign in
        </button>

        <div id="userBox" class="hidden items-center gap-2">
          <img id="userAvatar" class="w-8 h-8 rounded-full object-cover" src="">
          <span id="userName" class="text-sm"></span>
          <button id="signOutBtn" class="text-sm px-2 py-1">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Feed -->
  <main class="max-w-3xl mx-auto p-4 space-y-6" id="feedRoot">
    <div id="feedLoader" class="text-center text-gray-500 py-8">Loading feed…</div>
  </main>

  <div id="globalLoading" class="fixed right-4 bottom-4 bg-white px-3 py-2 rounded shadow hidden">Loading…</div>

  <!-- Post modal (large view) -->
  <div id="postModal" class="modal" aria-hidden="true">
    <div class="modal-inner">
      <div class="modal-media w-2/3 bg-black flex items-center justify-center p-2" id="modalMedia"></div>
      <div class="modal-info w-1/3 p-4 flex flex-col">
        <div class="flex items-center gap-3 mb-3">
          <img id="modalAuthorAvatar" class="w-10 h-10 rounded-full object-cover" src="">
          <div>
            <div id="modalAuthorName" class="font-semibold"></div>
            <div id="modalTime" class="small-muted text-xs"></div>
          </div>
          <button id="closeModal" class="ml-auto text-2xl text-gray-500">&times;</button>
        </div>

        <div id="modalCaption" class="text-sm text-gray-800 mb-3"></div>

        <div class="flex items-center gap-4 mb-3">
          <button id="modalLikeBtn" class="like-btn text-2xl text-gray-600"><i class="fa-regular fa-heart"></i></button>
          <div id="modalLikes" class="text-sm text-gray-700">0 likes</div>
          <button id="openCommentsBtn" class="text-2xl text-gray-600 ml-auto"><i class="fa-regular fa-comment"></i></button>
        </div>

        <div id="modalComments" class="flex-1 overflow-y-auto scrollbar-thin"></div>

        <form id="modalCommentForm" class="mt-3 flex gap-2">
          <input id="modalCommentInput" class="flex-1 border rounded-full px-3 py-2" placeholder="Add a comment..." />
          <button class="bg-violet-600 text-white px-4 py-2 rounded-full">Post</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Comments modal (shared) -->
  <div id="commentModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-60 items-center justify-center">
    <div class="bg-white rounded-lg w-full max-w-2xl mx-4 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <div class="font-semibold">Comments</div>
        <button class="close-comments text-xl">&times;</button>
      </div>
      <div id="commentsList" class="p-4 max-h-[60vh] overflow-y-auto scrollbar-thin"></div>
      <form id="commentForm" class="flex items-center gap-2 px-4 py-3 border-t">
        <input id="commentInput" class="flex-1 border rounded-full px-3 py-2" placeholder="Add a comment..." />
        <button class="bg-violet-600 text-white px-4 py-2 rounded-full">Post</button>
      </form>
    </div>
  </div>

  <!-- Script (module) -->
  <script type="module">
  // This file uses the shared modules in /assets/js/
  import { app, auth, db, storage } from '/assets/js/firebase-init.js';
  import { signInWithGoogle, signOutUser, onAuthChanged } from '/assets/js/auth.js';
  import { initComments } from '/assets/js/comments.js';
  import {
    collection, query, orderBy, startAfter, limit, getDocs, doc, getDoc,
    onSnapshot, setDoc, deleteDoc, addDoc, serverTimestamp, updateDoc, increment
  } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  // UI handles
  const signInBtn = document.getElementById('signInBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const userBox = document.getElementById('userBox');
  const userAvatar = document.getElementById('userAvatar');
  const userName = document.getElementById('userName');
  const feedRoot = document.getElementById('feedRoot');
  const feedLoader = document.getElementById('feedLoader');
  const globalLoading = document.getElementById('globalLoading');

  // modal handles
  const postModal = document.getElementById('postModal');
  const modalMedia = document.getElementById('modalMedia');
  const modalAuthorAvatar = document.getElementById('modalAuthorAvatar');
  const modalAuthorName = document.getElementById('modalAuthorName');
  const modalTime = document.getElementById('modalTime');
  const modalCaption = document.getElementById('modalCaption');
  const modalLikes = document.getElementById('modalLikes');
  const modalLikeBtn = document.getElementById('modalLikeBtn');
  const modalComments = document.getElementById('modalComments');
  const modalCommentForm = document.getElementById('modalCommentForm');
  const modalCommentInput = document.getElementById('modalCommentInput');
  const openCommentsBtn = document.getElementById('openCommentsBtn');
  const closeModalBtn = document.getElementById('closeModal');

  // comments modal elements used by initComments (the module expects these ids)
  // #commentModal, #commentsList, #commentForm, #commentInput are present in the page

  // State
  let currentUser = null;
  let followedUsersSet = new Set();
  let postPageCursor = null;
  const POSTS_BATCH_SIZE = 10;
  const SERVER_BATCH = 20;
  let fetching = false;
  let reachedEnd = false;

  // Auth wiring
  signInBtn.addEventListener('click', async () => {
    signInBtn.disabled = true;
    try { await signInWithGoogle(); } catch (e) { console.error(e); alert('Sign-in failed'); }
    finally { signInBtn.disabled = false; }
  });
  signOutBtn?.addEventListener('click', signOutUser);

  onAuthChanged(async (user) => {
    currentUser = user;
    if (user) {
      signInBtn.style.display = 'none';
      userBox.style.display = 'flex';
      userAvatar.src = user.photoURL || `https://i.pravatar.cc/80?u=${user.uid}`;
      userName.textContent = user.displayName || user.email || 'You';
      await loadFollowedUsersAndInit(user.uid, true);
    } else {
      signInBtn.style.display = 'inline-flex';
      userBox.style.display = 'none';
      feedRoot.innerHTML = `<div class="text-center text-gray-500 py-8">Sign in to view your feed.</div>`;
    }
  });

  // Helper
  const showGlobalLoading = (s) => globalLoading.classList.toggle('hidden', !s);
  const timeAgo = (d) => {
    const seconds = Math.floor((Date.now() - new Date(d)) / 1000);
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds/60);
    if (minutes < 60) return `${minutes}m`;
    const hours = Math.floor(minutes/60);
    if (hours < 24) return `${hours}h`;
    const days = Math.floor(hours/24);
    return `${days}d`;
  };
  const escapeHtml = (s) => s ? String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]) : '';

  // ------------- Followed users loader -------------
  async function loadFollowedUsersAndInit(uid, resetFeed=false) {
    try {
      const uDoc = await getDoc(doc(db, 'users', uid));
      let following = [];
      if (uDoc.exists()) following = uDoc.data().following || [];
      if (!following.includes(uid)) following.unshift(uid);
      followedUsersSet = new Set(following);
      if (resetFeed) { postPageCursor = null; feedRoot.innerHTML = ''; reachedEnd = false; }
      await loadMorePosts();
    } catch (err) {
      console.error('loadFollowedUsersAndInit', err);
      feedRoot.innerHTML = `<div class="text-center text-red-500 py-8">Failed to load feed — check console</div>`;
    }
  }

  // ------------- Infinite scroll + server batching -------------
  async function loadMorePosts() {
    if (fetching || reachedEnd) return;
    fetching = true;
    showGlobalLoading(true);

    try {
      let q;
      if (!postPageCursor) q = query(collection(db, 'posts'), orderBy('timestamp','desc'), limit(SERVER_BATCH));
      else q = query(collection(db, 'posts'), orderBy('timestamp','desc'), startAfter(postPageCursor), limit(SERVER_BATCH));

      const snap = await getDocs(q);
      if (snap.empty) {
        if (!postPageCursor) feedRoot.innerHTML = `<div class="text-center text-gray-500 py-8">No posts yet.</div>`;
        reachedEnd = true;
        fetching = false;
        showGlobalLoading(false);
        return;
      }

      postPageCursor = snap.docs[snap.docs.length - 1];

      let collected = 0;
      for (const d of snap.docs) {
        const data = d.data();
        const postId = d.id;
        if (!followedUsersSet.has(data.authorId)) continue; // skip users not followed
        renderPostCard(postId, data);
        collected++;
        if (collected >= POSTS_BATCH_SIZE) break;
      }

      if (collected < POSTS_BATCH_SIZE && !reachedEnd) {
        if (snap.size < SERVER_BATCH) reachedEnd = true;
        else await loadMorePosts();
      }
    } catch (err) {
      console.error('loadMorePosts', err);
    } finally {
      fetching = false;
      showGlobalLoading(false);
      feedLoader.classList.add('hidden');
    }
  }

  window.addEventListener('scroll', () => {
    if (fetching || reachedEnd) return;
    if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 600)) loadMorePosts();
  });

  // ------------- Render single post -------------
  function renderPostCard(postId, data) {
    if (document.getElementById(`post-${postId}`)) return;

    const card = document.createElement('article');
    card.id = `post-${postId}`;
    card.className = 'post-card';

    // header
    const header = document.createElement('div');
    header.className = 'flex items-center gap-3 p-4';
    header.innerHTML = `<img src="${escapeHtml(data.authorPhoto || `https://i.pravatar.cc/40?u=${data.authorId||'anon'}`)}" class="w-10 h-10 rounded-full object-cover">
                        <div><div class="font-semibold">${escapeHtml(data.authorName||'User')}</div>
                        <div class="small-muted text-xs">${timeAgo(data.timestamp?.toDate?.()||new Date())}</div></div>
                        <div class="ml-auto pr-2 text-gray-400"><i class="fa-solid fa-ellipsis"></i></div>`;
    card.appendChild(header);

    // media + overlay
    const mediaWrap = document.createElement('div');
    mediaWrap.className = 'relative post-media bg-black';
    mediaWrap.style.maxHeight = '78vh';
    let mediaEl;
    if (data.type === 'video' && data.videoUrl) {
      mediaEl = document.createElement('video');
      mediaEl.src = data.videoUrl;
      mediaEl.controls = true;
      mediaEl.preload = 'metadata';
    } else {
      mediaEl = document.createElement('img');
      mediaEl.src = data.imageUrl || '';
      mediaEl.loading = 'lazy';
    }
    mediaEl.className = 'w-full';
    mediaWrap.appendChild(mediaEl);

    // heart anim
    const heartOverlay = document.createElement('div');
    heartOverlay.className = 'heart-anim';
    heartOverlay.id = `heart-${postId}`;
    heartOverlay.innerHTML = '❤';
    mediaWrap.appendChild(heartOverlay);

    // double-tap detection
    let lastTap = 0;
    mediaWrap.addEventListener('click', async () => {
      const now = Date.now();
      if (now - lastTap < 300) {
        await handleDoubleTap(postId, heartOverlay);
      }
      lastTap = now;
    });

    card.appendChild(mediaWrap);

    // actions
    const actions = document.createElement('div');
    actions.className = 'flex items-center justify-between px-4 py-3';
    const left = document.createElement('div');
    left.className = 'flex items-center gap-4';

    const likeBtn = document.createElement('button');
    likeBtn.className = 'like-btn text-2xl text-gray-600';
    likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
    left.appendChild(likeBtn);

    const commentBtn = document.createElement('button');
    commentBtn.className = 'comment-btn text-2xl text-gray-600 open-comments';
    commentBtn.innerHTML = '<i class="fa-regular fa-comment"></i>';
    commentBtn.dataset.postId = postId; // for comments.js wiring
    left.appendChild(commentBtn);

    actions.appendChild(left);
    const bookmark = document.createElement('i');
    bookmark.className = 'fa-regular fa-bookmark text-gray-600';
    actions.appendChild(bookmark);

    card.appendChild(actions);

    // meta: likes, caption, comments count
    const meta = document.createElement('div');
    meta.className = 'px-4 pb-4';
    meta.innerHTML = `<div id="likes-${postId}" class="text-sm text-gray-800 mb-1">0 likes</div>
                      <div class="text-sm text-gray-700 mb-2"><span class="font-semibold">${escapeHtml(data.authorName||'')}</span> ${escapeHtml(data.caption||'')}</div>
                      <div id="comments-count-${postId}" class="text-xs text-gray-500"></div>`;
    card.appendChild(meta);

    feedRoot.appendChild(card);

    // --- realtime subscriptions for likes/comments ---
    const postRef = doc(db, 'posts', postId);

    // post doc listener (for likesCount)
    const unsubPostDoc = onSnapshot(postRef, snap => {
      if (!snap.exists()) return;
      const pd = snap.data();
      const el = document.getElementById(`likes-${postId}`);
      if (el) el.textContent = `${pd.likesCount || 0} like${(pd.likesCount||0)===1 ? '' : 's'}`;
    });

    // likes subcollection listener to detect if current user liked
    const likesColRef = collection(postRef, 'likes');
    const unsubLikes = onSnapshot(likesColRef, snap => {
      const user = currentUser;
      const liked = user && snap.docs.some(d => d.id === user.uid);
      if (liked) {
        likeBtn.classList.add('liked');
        likeBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
      } else {
        likeBtn.classList.remove('liked');
        likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
      }
    });

    // comments count listener
    const commentsColRef = collection(postRef, 'comments');
    const unsubComments = onSnapshot(commentsColRef, snap => {
      const el = document.getElementById(`comments-count-${postId}`);
      if (el) el.textContent = `${snap.size} comment${snap.size === 1 ? '' : 's'}`;
    });

    // like click
    likeBtn.addEventListener('click', async () => {
      if (!currentUser) { alert('Sign in to like posts'); return; }
      await toggleLike(postId);
    });

    // comment click will be handled by comments.js init (buttons have class open-comments)
    // store unsubs to cleanup if needed
    card._unsub = () => { unsubPostDoc(); unsubLikes(); unsubComments(); };
  }

  // ------------- toggle like (per-user like doc + increment) -------------
  async function toggleLike(postId) {
    if (!currentUser) return;
    const likeRef = doc(db, 'posts', postId, 'likes', currentUser.uid);
    try {
      const snap = await getDoc(likeRef);
      if (snap.exists()) {
        // unlike
        await deleteDoc(likeRef);
        await updateDoc(doc(db, 'posts', postId), { likesCount: increment(-1) });
      } else {
        // like
        await setDoc(likeRef, { userId: currentUser.uid, createdAt: serverTimestamp() });
        await updateDoc(doc(db, 'posts', postId), { likesCount: increment(1) });
      }
    } catch (err) {
      console.error('toggleLike', err);
    }
  }

  // ------------- double-tap like -------------
  async function handleDoubleTap(postId, heartOverlayEl) {
    if (!currentUser) { alert('Sign in to like posts'); return; }
    const likeRef = doc(db, 'posts', postId, 'likes', currentUser.uid);
    const snap = await getDoc(likeRef);
    if (snap.exists()) {
      // already liked -> unlike (no animation)
      await deleteDoc(likeRef);
      await updateDoc(doc(db, 'posts', postId), { likesCount: increment(-1) });
    } else {
      // like + animation
      heartOverlayEl.classList.add('show');
      setTimeout(()=> heartOverlayEl.classList.remove('show'), 500);
      await setDoc(likeRef, { userId: currentUser.uid, createdAt: serverTimestamp() });
      await updateDoc(doc(db, 'posts', postId), { likesCount: increment(1) });
    }
  }

  // ------------- Comments wiring (shared module) -------------
  // Initialize the reusable comments modal: it expects .open-comments buttons to have data-post-id
  initComments({
    openButtonsSelector: '.open-comments',
    modalSelector: '#commentModal',
    listSelector: '#commentsList',
    formSelector: '#commentForm',
    inputSelector: '#commentInput',
    onOpen: (postId) => {
      // (optional) pre-fill or scroll behavior
      // console.log('Comments open for', postId);
    }
  });

  // ------------- Post modal (large view) -------------
  let activeModalUnsubLikes = null;
  let activeModalUnsubComments = null;
  let activeModalPostId = null;

  function openPostModal(postId, postData) {
    // set active id
    activeModalPostId = postId;
    modalMedia.innerHTML = '';
    modalAuthorAvatar.src = postData.authorPhoto || `https://i.pravatar.cc/40?u=${postData.authorId||'anon'}`;
    modalAuthorName.textContent = postData.authorName || postData.authorId || 'Unknown';
    modalCaption.textContent = postData.caption || '';
    modalTime.textContent = timeAgo(postData.timestamp?.toDate?.() || new Date());

    if (postData.type === 'video' && postData.videoUrl) {
      const v = document.createElement('video'); v.src = postData.videoUrl; v.controls = true; v.autoplay = true; v.className = 'w-full h-auto';
      modalMedia.appendChild(v);
    } else {
      const img = document.createElement('img'); img.src = postData.imageUrl || ''; img.className = 'w-full h-auto object-contain';
      modalMedia.appendChild(img);
    }

    postModal.classList.add('show');

    // likes realtime (post doc)
    if (activeModalUnsubLikes) activeModalUnsubLikes();
    activeModalUnsubLikes = onSnapshot(doc(db, 'posts', postId), snap => {
      if (!snap.exists()) return;
      const d = snap.data();
      modalLikes.textContent = `${d.likesCount || 0} like${(d.likesCount||0)===1 ? '' : 's'}`;
    });

    // comments realtime (modal)
    if (activeModalUnsubComments) activeModalUnsubComments();
    activeModalUnsubComments = onSnapshot(query(collection(doc(db, 'posts', postId), 'comments'), orderBy('createdAt','asc')), snap => {
      modalComments.innerHTML = '';
      snap.forEach(cs => {
        const c = cs.data();
        const node = document.createElement('div'); node.className = 'flex items-start gap-3 mb-3';
        node.innerHTML = `<img src="${escapeHtml(c.userAvatar||`https://i.pravatar.cc/40?u=${c.userId||'anon'}`)}" class="w-8 h-8 rounded-full">
                          <div><div class="font-semibold text-sm">${escapeHtml(c.userName)}</div><div class="text-sm text-gray-700">${escapeHtml(c.text)}</div></div>`;
        modalComments.appendChild(node);
      });
    });

    // wire modal like btn
    modalLikeBtn.onclick = async () => { if (!currentUser) { alert('Sign in to like'); return; } await toggleLike(postId); };
    // modal comment submit
    modalCommentForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) { alert('Sign in to comment'); return; }
      const txt = modalCommentInput.value.trim();
      if (!txt) return;
      await addDoc(collection(doc(db,'posts',postId),'comments'), {
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email || 'You',
        userAvatar: currentUser.photoURL || `https://i.pravatar.cc/60?u=${currentUser.uid}`,
        text: txt,
        createdAt: serverTimestamp()
      });
      modalCommentInput.value = '';
    };
  }

  closeModalBtn.addEventListener('click', () => {
    postModal.classList.remove('show');
    if (activeModalUnsubLikes) activeModalUnsubLikes(); activeModalUnsubLikes = null;
    if (activeModalUnsubComments) activeModalUnsubComments(); activeModalUnsubComments = null;
    activeModalPostId = null;
    modalMedia.innerHTML = '';
  });

  postModal.addEventListener('click', (e) => { if (e.target === postModal) closeModalBtn.click(); });

  // ------------- Public API so other pages can open post modal -------------
  window.rivoFeed = {
    openPostModal: openPostModal,
    loadMorePosts
  };

  // Initial small UI hint
  setTimeout(()=> feedLoader.classList.remove('hidden'), 80);

  </script>
</body>
</html>
