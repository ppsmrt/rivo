<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload - Rivo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-4 bg-white">

  <h1 class="text-xl font-semibold mb-4">New Post</h1>

  <form id="uploadForm" class="space-y-3">
    <input type="file" id="fileInput" accept="image/*,video/*" required />
    <input id="caption" placeholder="Write a caption..." class="w-full border px-3 py-2 rounded" />
    <button class="bg-violet-600 text-white px-4 py-2 rounded">Upload</button>
  </form>

  <div id="progress" class="mt-4 text-sm text-gray-600"></div>

  <script type="module">
    import { auth, db, storage } from "/assets/js/firebase-init.js";
    import { onAuthChanged } from "/assets/js/auth.js";
    import { ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const captionInput = document.getElementById('caption');
    const progressEl = document.getElementById('progress');

    let currentUser = null;
    onAuthChanged(user => currentUser = user);

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return alert('Sign in to upload posts');

      const file = fileInput.files[0];
      if (!file) return alert('Choose a file first');

      // decide folder & filename
      const ext = file.name.split('.').pop();
      const id = Date.now().toString();
      const filePath = `posts/${currentUser.uid}/${id}.${ext}`;
      const sRef = storageRef(storage, filePath);
      const uploadTask = uploadBytesResumable(sRef, file);

      uploadTask.on('state_changed', (snapshot) => {
        const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        progressEl.textContent = `Uploading: ${pct}%`;
      }, (err) => {
        console.error(err);
        alert('Upload failed');
      }, async () => {
        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
        // create post doc
        const postsCol = collection(db, "posts");
        const docRef = await addDoc(postsCol, {
          authorId: currentUser.uid,
          authorName: currentUser.displayName || currentUser.email,
          authorPhoto: currentUser.photoURL || "",
          caption: captionInput.value || "",
          imageUrl: file.type.startsWith('image/') ? downloadURL : "",
          videoUrl: file.type.startsWith('video/') ? downloadURL : "",
          type: file.type.startsWith('video/') ? 'video' : 'image',
          timestamp: serverTimestamp()
        });
        progressEl.textContent = "Upload complete â€” post created";
        // optionally redirect to post or feed
        setTimeout(()=> window.location.href = "/explore.html", 900);
      });
    });
  </script>
</body>
</html>