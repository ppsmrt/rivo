<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Messages - Rivo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <main class="max-w-3xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Messages</h1>
    <div id="chatList" class="space-y-2">
      <!-- Chats will be injected here -->
    </div>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, onValue, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  const chatListEl = document.getElementById('chatList');

  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const chatsRef = ref(db, 'chats');
    onValue(chatsRef, snapshot => {
      chatListEl.innerHTML = '';
      if (!snapshot.exists()) {
        chatListEl.innerHTML = `<div class="text-gray-500">No chats found</div>`;
        return;
      }
      snapshot.forEach(chatSnap => {
        const chat = chatSnap.val();
        const chatId = chatSnap.key;

        // Only show if user is a participant
        if (!chat.participants || !Object.keys(chat.participants).includes(user.uid)) return;

        const lastMsg = chat.lastMessage ? (chat.lastMessage.text || "[Image]") : "No messages yet";
        const chatName = chat.isGroup ? chat.name : chat.otherUserName || "Chat";
        const avatar = chat.avatar || 'https://i.pravatar.cc/40';

        const div = document.createElement('div');
        div.className = "flex items-center p-3 bg-white rounded shadow cursor-pointer hover:bg-gray-100";
        div.innerHTML = `
          <img src="${avatar}" class="w-10 h-10 rounded-full mr-3" />
          <div class="flex-1">
            <div class="font-semibold">${chatName}</div>
            <div class="text-sm text-gray-500 truncate">${lastMsg}</div>
          </div>
        `;
        div.addEventListener('click', () => {
          window.location.href = `chat.html?chatId=${chatId}`;
        });
        chatListEl.appendChild(div);
      });
    });
  });
</script>
</body>
</html>