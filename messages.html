<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rivo - Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-violet-600 text-white p-4 shadow">
    <div class="max-w-3xl mx-auto flex justify-between items-center">
      <h1 class="text-lg font-semibold">Messages</h1>
      <div>
        <button id="signInBtn" class="bg-white text-violet-600 px-3 py-1 rounded">Sign in</button>
        <button id="signOutBtn" class="hidden bg-red-500 text-white px-3 py-1 rounded">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-4">
    <div id="chatList" class="space-y-3">
      <!-- Conversations will load here -->
    </div>
  </main>

  <script type="module">
    import '/assets/js/realtime-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const auth = getAuth();
    const db = getDatabase();

    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const chatList = document.getElementById('chatList');

    // Auth state
    onAuthStateChanged(auth, user => {
      if (user) {
        signInBtn.classList.add('hidden');
        signOutBtn.classList.remove('hidden');
        loadChats(user.uid);
      } else {
        signInBtn.classList.remove('hidden');
        signOutBtn.classList.add('hidden');
        chatList.innerHTML = `<p class="text-gray-500">Sign in to see your messages.</p>`;
      }
      window.dispatchEvent(new CustomEvent('rivo:authChange', { detail: user }));
    });

    signInBtn.addEventListener('click', () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider).catch(console.error);
    });

    signOutBtn.addEventListener('click', () => {
      signOut(auth).catch(console.error);
    });

    function loadChats(uid) {
      onValue(ref(db, `userChats/${uid}`), snap => {
        if (!snap.exists()) {
          chatList.innerHTML = `<p class="text-gray-500">No conversations yet.</p>`;
          return;
        }
        const chats = snap.val();
        chatList.innerHTML = '';
        Object.keys(chats).forEach(chatId => {
          const chat = chats[chatId];
          const otherUser = chat.participants.find(id => id !== uid);
          chatList.innerHTML += `
            <div class="p-4 bg-white rounded shadow flex justify-between items-center">
              <div>
                <p class="font-semibold">${chat.lastMessageSender || 'User'}</p>
                <p class="text-sm text-gray-500 truncate w-48">${chat.lastMessage || ''}</p>
              </div>
              <a href="chat.html?chatId=${chatId}" class="bg-violet-600 text-white px-3 py-1 rounded">Open</a>
            </div>
          `;
        });
      });
    }
  </script>
</body>
</html>